<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>NYC Map</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
html,body{margin:0;padding:0;height:100%;width:100%;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;}
#map{height:100vh;width:100%;}

.version-box{
  position:absolute;top:10px;right:10px;background:white;padding:4px 8px;border-radius:10px;
  box-shadow:0 3px 10px rgba(0,0,0,0.15);font-weight:600;font-size:12px;z-index:1000;
}

#refreshLocation{
  position:absolute;top:40px;right:10px;width:100px;background:#007bff;color:#fff;border:none;
  padding:4px 8px;border-radius:10px;cursor:pointer;box-shadow:0 3px 10px rgba(0,0,0,0.15);
  font-size:12px;z-index:1000;
}
#refreshLocation:hover{background:#0056b3;}

#location-container{
  position:absolute;top:70px;right:10px;width:170px;max-height:60vh;
  background:white;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.15);
  display:flex;flex-direction:column;z-index:1000;font-size:12px;
}

#location-header{
  padding: 6px 8px;background:white;cursor:pointer;border-radius:12px 12px;
  font-weight:bold;border-bottom:1px solid #ccc;text-align: center;
}

#searchBox{
  display:none;margin:5px auto;padding:5px 7px;border-radius:5px;border:1px solid #ccc;
  font-size:12px;outline:none;background:white;width:calc(100% - 20px);
}

#locationList{
  overflow-y:auto;flex:1;padding:0;margin:0;display:none;border-top:1px solid #ccc;
}

.category-title{
  font-weight:bold;padding:5px 10px;border-bottom:1px solid #ddd;background:#f9f9f9;
}

.location-item{
  cursor:pointer;padding:5px 10px;border-bottom:1px solid #eee;transition:background 0.15s;
}
.location-item:last-child{border-bottom:none;}
.location-item:hover{background:#eaeaea;}

#routeInfo{
  position:absolute;bottom:2px;left:50%;transform:translateX(-50%);
  background:white;padding:8px 12px;border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);font-size:12px;z-index:1000;
  max-width:95%;line-height:1.2em;max-height:4.5em;overflow:hidden;
  white-space:pre-wrap;text-overflow:ellipsis;
}

@media (max-width:600px){
  #location-container{width:157px;top:60px;}
  #searchBox{width:calc(100% - 20px);}
  .version-box{font-size:11px;padding:3px 6px;}
  #refreshLocation{font-size:11px;padding:3px 6px;top:35px;right:10px;width:100px;}
}
</style>
</head>
<body>
<div id="map"></div>
<div class="version-box" id="versionBox">NYC MAP 24/12/2025 v8.8</div>
<button id="refreshLocation">My Location</button>

<div id="location-container">
  <div id="location-header">Select Location ▼</div>
  <input type="text" id="searchBox" placeholder="Search..." />
  <div id="locationList"></div>
</div>

<div id="routeInfo">Select a location to see walking distance & time</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// --- Map ---
var map = L.map('map').setView([40.7484, -73.9857],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

// --- Icons ---
var icons = {
  hotel: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/red-dot.png', iconSize:[32,32]}),
  sight: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/green-dot.png', iconSize:[32,32]}),
  food: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/orange-dot.png', iconSize:[32,32]}),
  rooftop: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/purple-dot.png', iconSize:[32,32]}),
  subway: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/blue-dot.png', iconSize:[28,28]}),
  hidden: L.icon({iconUrl:'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png', iconSize:[32,32]})
};

// --- User location ---
var userMarker = L.circleMarker([0,0], {radius:8, color:'#007bff', fillColor:'#007bff', fillOpacity:1}).addTo(map);
var currentLatLng = [null,null];
var followUser=false;
var selectedLocation = null;

// --- Locations ---
var locations = { /* your locations, rooftop, hidden, food & subway stations as in your last version */ };

// --- Subway lines data ---
var subwayLines = [
  {line:"1",stations:["South Ferry","Rector St (1)","34th St – Penn Station"]},
  {line:"2",stations:["Wall St (2,3)","14th St – Union Square","42nd St – Times Sq"]},
  {line:"3",stations:["Wall St (2,3)","14th St – Union Square","42nd St – Times Sq"]},
  {line:"A",stations:["34th St – Penn Station (A, C, E)","59th St – Columbus Circle"]},
  {line:"C",stations:["34th St – Penn Station (A, C, E)","59th St – Columbus Circle"]},
  {line:"E",stations:["34th St – Penn Station (A, C, E)","42nd St – Port Authority Bus Terminal"]},
  {line:"J",stations:["Brooklyn Bridge – City Hall (J, Z)","Broadway Junction"]},
  {line:"Z",stations:["Brooklyn Bridge – City Hall (J, Z)","Broadway Junction"]}
  // add more lines as needed
];

// --- Create markers ---
var markers = {};
for (let cat in locations) {
  for (let name in locations[cat]) {
    const loc = locations[cat][name];
    const marker = L.marker([loc[0], loc[1]], {icon: icons[loc[2]]});
    if(loc[2]!=="subway") marker.addTo(map);
    marker.bindPopup(name);
    marker.on('click', function(){
      selectedLocation = [loc[0], loc[1]];
      map.setView(selectedLocation, map.getZoom());
      showDistance(selectedLocation, name);
    });
    markers[name] = marker;
  }
}

// --- Subway polylines ---
var subwayPolylines = [];
function drawSubwayLines() {
  subwayPolylines.forEach(line=>map.removeLayer(line));
  subwayPolylines = [];
  subwayLines.forEach(line=>{
    var latlngs = line.stations.map(st => [locations["Subway Stations"][st][0], locations["Subway Stations"][st][1]]);
    var polyline = L.polyline(latlngs, {color:'blue', weight:3, opacity:0.7});
    polyline.addTo(map);
    subwayPolylines.push(polyline);
  });
}

// --- Show distance & walking time ---
function showDistance(latlng,name){
  if(!currentLatLng[0]) return;
  const R = 6371e3;
  const φ1 = currentLatLng[0]*Math.PI/180;
  const φ2 = latlng[0]*Math.PI/180;
  const Δφ = (latlng[0]-currentLatLng[0])*Math.PI/180;
  const Δλ = (latlng[1]-currentLatLng[1])*Math.PI/180;
  const a = Math.sin(Δφ/2)**2+Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  const d = R*c;
  const walkSpeed = 1.4;
  const timeMin = Math.ceil(d/walkSpeed/60);
  const distKm = (d/1000).toFixed(2);
  document.getElementById("routeInfo").innerText=`${name}\nDistance: ${distKm} km\nWalking time: ${timeMin} min`;
}

// --- Subway toggle ---
var locationList = document.getElementById("locationList");
var subwayContainer = document.createElement("div");
subwayContainer.id="subwayToggleContainer";
subwayContainer.style.display="none";
subwayContainer.style.alignItems="center";
subwayContainer.style.padding="5px 10px";
var subwayCheckbox = document.createElement("input");
subwayCheckbox.type="checkbox";
subwayCheckbox.id="subwayCheckbox";
subwayCheckbox.style.marginRight="6px";
var subwayLabel = document.createElement("label");
subwayLabel.htmlFor="subwayCheckbox";
subwayLabel.innerText="Show Subway Stations & Lines";
subwayLabel.style.fontSize="12px";
subwayContainer.appendChild(subwayCheckbox);
subwayContainer.appendChild(subwayLabel);
document.getElementById("location-container").appendChild(subwayContainer);

// --- Populate location list ---
for (let cat in locations){
  const title = document.createElement("div");
  title.className="category-title";
  title.innerText=cat;
  locationList.appendChild(title);
  for(let name in locations[cat]){
    const loc = locations[cat][name];
    const marker = markers[name];
    const div = document.createElement("div");
    div.className="location-item";
    div.innerText=name;
    if(cat==="Subway Stations") div.style.display="none";
    div.onclick=function(){
      selectedLocation=[loc[0],loc[1]];
      marker.openPopup();
      map.setView(selectedLocation,map.getZoom());
      showDistance(selectedLocation,name);
      locationList.style.display="none";
      document.getElementById("searchBox").style.display="none";
      subwayContainer.style.display="none";
      followUser=false;
    };
    locationList.appendChild(div);
  }
}

// --- Subway checkbox event ---
subwayCheckbox.addEventListener("change",function(){
  const show=this.checked;
  for(let name in locations["Subway Stations"]){
    if(show) markers[name].addTo(map);
    else map.removeLayer(markers[name]);
  }
  if(show) drawSubwayLines();
  else subwayPolylines.forEach(line=>map.removeLayer(line));
  const items=locationList.getElementsByClassName("location-item");
  for(let i=0;i<items.length;i++){
    const itemName=items[i].innerText;
    if(locations["Subway Stations"][itemName]) items[i].style.display=show?"block":"none";
  }
});

// --- Collapsible list ---
document.getElementById("location-header").addEventListener("click",function(){
  const list=document.getElementById("locationList");
  const search=document.getElementById("searchBox");
  if(list.style.display==="none" || list.style.display===""){
    list.style.display="block";
    search.style.display="block";
    subwayContainer.style.display="flex";
  } else {
    list.style.display="none";
    search.style.display="none";
    subwayContainer.style.display="none";
  }
});

// --- Search ---
document.getElementById("searchBox").addEventListener("input",function(){
  const q=this.value.toLowerCase();
  const items=document.getElementsByClassName("location-item");
  for(let i=0;i<items.length;i++){
    items[i].style.display=items[i].innerText.toLowerCase().includes(q)?"block":"none";
  }
});

// --- Geolocation ---
function updatePosition(pos){
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  currentLatLng = [lat, lon];
  userMarker.setLatLng([lat, lon]);
  if(followUser) map.panTo([lat, lon]);
  if(selectedLocation) {
    const name = document.getElementById("routeInfo").innerText.split("\n")[0];
    showDistance(selectedLocation, name);
  }
}

if(navigator.geolocation){
  navigator.geolocation.watchPosition(updatePosition, function(err){
    console.warn(err);
  }, {enableHighAccuracy:true});
}

// --- My Location button ---
document.getElementById("refreshLocation").addEventListener("click", function(){
  if(navigator.geolocation){
    followUser = true;
    navigator.geolocation.getCurrentPosition(updatePosition, {enableHighAccuracy:true});
    selectedLocation = null;
    document.getElementById("routeInfo").innerText = "Select a location to see walking distance & time";
  } else {
    alert("Geolocation not available");
  }
});
</script>
</body>
</html>
