  "Rooftop Bars": {
    "Le Bain":[40.7416,-74.0072,"rooftop"],
    "The Public":[40.7278,-74.0020,"rooftop"],
    "Darling Rooftop Bar and Lounge":[40.7675,-73.9819,"rooftop"]
  },
  "Food & Drinks": {
    "Blue Bottle":[40.7410,-73.9887,"food"],
    "Tompkins Bagels":[40.7282,-73.9911,"food"],
    "Black Seed Bagels":[40.7230,-73.9973,"food"],
    "Chipotle":[40.7591,-73.9840,"food"],
    "Baby Luc's (Pizza)":[40.6761,-73.9981,"food"]
  },
  "Subway Stations": {}
};

// --- Add markers (without subways initially) ---
var markers = {};
for(let category in locations){
  for(let key in locations[category]){
    let loc = locations[category][key];
    let marker = L.marker([loc[0],loc[1]], {icon: icons[loc[2]]}).addTo(map);
    marker.bindPopup(key);
    marker.on('click', function(){ showDistance([loc[0],loc[1]], key); });
    markers[key] = marker;
  }
}

// Add “You are here”
L.marker(currentLocation, {icon: icons.me}).addTo(map).bindPopup("You are here");

// Distance/time function
function showDistance(latlng,name){
  var R = 6371e3;
  var φ1 = currentLocation[0]*Math.PI/180;
  var φ2 = latlng[0]*Math.PI/180;
  var Δφ = (latlng[0]-currentLocation[0])*Math.PI/180;
  var Δλ = (latlng[1]-currentLocation[1])*Math.PI/180;
  var a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
  var c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  var d = R*c; 
  var walkSpeed = 1.4; 
  var timeMin = Math.ceil(d / walkSpeed / 60);
  var distKm = (d/1000).toFixed(2);
  document.getElementById("routeInfo").innerText = `${name}\nDistance: ${distKm} km\nEstimated walking time: ${timeMin} min`;
}

// Subway toggle
var subwayContainer = document.createElement("div");
subwayContainer.id = "subwayToggleContainer";
subwayContainer.style.display = "none";
subwayContainer.style.alignItems = "center";
subwayContainer.style.padding = "5px 10px";

var subwayCheckbox = document.createElement("input");
subwayCheckbox.type = "checkbox";
subwayCheckbox.id = "subwayCheckbox";
subwayCheckbox.style.marginRight = "6px";

var subwayLabel = document.createElement("label");
subwayLabel.htmlFor = "subwayCheckbox";
subwayLabel.innerText = "Show Subway Stations";
subwayLabel.style.fontSize = "12px";

subwayContainer.appendChild(subwayCheckbox);
subwayContainer.appendChild(subwayLabel);
document.getElementById("location-container").appendChild(subwayContainer);

// Add all subway stations (hidden)
var subways = {
  "South Ferry":[40.701309,-74.013119,"subway"],
  "Bowling Green":[40.704288,-74.014027,"subway"],
  "Whitehall St":[40.703087,-74.012994,"subway"],
  "Wall St (4,5)":[40.706821,-74.0091,"subway"],
  "Fulton St":[40.710374,-74.007582,"subway"],
  "Chambers St":[40.714111,-74.009039,"subway"],
  "14th St":[40.737826,-74.000236,"subway"],
  "34th St – Penn Station":[40.750373,-73.99339,"subway"],
  "42nd St – Times Sq":[40.75529,-73.987495,"subway"],
  "59th St – Columbus Circle":[40.768044,-73.981893,"subway"],
  "86th St":[40.788644,-73.976218,"subway"],
  "125th St":[40.815581,-73.958372,"subway"]
};

for (let name in subways) {
  let loc = subways[name];
  let marker = L.marker([loc[0], loc[1]], {icon: icons.subway});
  marker.bindPopup(name);
  marker.on('click', function(){ showDistance([loc[0],loc[1]], name); });
  markers[name] = marker;
}

// Toggle event
subwayCheckbox.addEventListener("change", function(){
  let show = this.checked;
  for (let name in subways) {
    if(show) markers[name].addTo(map);
    else map.removeLayer(markers[name]);
  }
});

// Collapsible toggle
var header = document.getElementById("location-header");
header.addEventListener("click", function(){
  var list = document.getElementById("locationList");
  var search = document.getElementById("searchBox");
  if(list.style.display==="none"){
    list.style.display="block";
    search.style.display="block";
    subwayContainer.style.display="flex";
  } else {
    list.style.display="none";
    search.style.display="none";
    subwayContainer.style.display="none";
  }
});

// Search filter
var searchBox = document.getElementById("searchBox");
searchBox.addEventListener("input", function(){
  var filter = this.value.toLowerCase();
  var items = document.getElementsByClassName("location-item");
  for(var i=0;i<items.length;i++){
    if(items[i].innerText.toLowerCase().indexOf(filter)>-1){
      items[i].style.display = "";
    } else {
      items[i].style.display = "none";
    }
  }
});
</script>
</body>
</html>
